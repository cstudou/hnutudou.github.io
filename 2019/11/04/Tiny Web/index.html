<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linux C/C++,网络编程," />





  <link rel="alternate" href="/atom.xml" title="Tudou" type="application/atom+xml" />






<meta name="description" content="简介： Tiny Web 项目">
<meta name="keywords" content="Linux C&#x2F;C++,网络编程">
<meta property="og:type" content="article">
<meta property="og:title" content="Tiny Web">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;11&#x2F;04&#x2F;Tiny%20Web&#x2F;index.html">
<meta property="og:site_name" content="Tudou">
<meta property="og:description" content="简介： Tiny Web 项目">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;cy-pic.kuaizhan.com&#x2F;g3&#x2F;16&#x2F;84&#x2F;727b-027a-4fe5-885c-5e3c480ca81200?sign=3d85ce18f45e8dd3544935e1884fddaa&amp;t=1572860741">
<meta property="og:image" content="https:&#x2F;&#x2F;cy-pic.kuaizhan.com&#x2F;g3&#x2F;f0&#x2F;06&#x2F;7e7f-cec2-42d4-bf82-0b6eb453137992?sign=5af41daccf2b93eeda432cd7ede0a2b4&amp;t=1572860706">
<meta property="og:image" content="https:&#x2F;&#x2F;cy-pic.kuaizhan.com&#x2F;g3&#x2F;78&#x2F;d7&#x2F;0e85-0be1-4da3-92d9-3a12a4f9e57d06?sign=f02b8de39d7be9b21cb411eb7c2e9667&amp;t=1572863982">
<meta property="og:updated_time" content="2019-11-04T11:52:43.708Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;cy-pic.kuaizhan.com&#x2F;g3&#x2F;16&#x2F;84&#x2F;727b-027a-4fe5-885c-5e3c480ca81200?sign=3d85ce18f45e8dd3544935e1884fddaa&amp;t=1572860741">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/11/04/Tiny Web/"/>





  <title>Tiny Web | Tudou</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tudou</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">study & life</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/04/Tiny%20Web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tudou">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p2.so.qhmsg.com/t010d44e4aa0fd98f91.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tudou">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tiny Web</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-04T17:21:07+08:00">
                2019-11-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/csapp/" itemprop="url" rel="index">
                    <span itemprop="name">csapp</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数:</span>
                
                <span title="Words count in article">
                  3.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text"> 阅读时长&asymp;</span>
                
                <span title="Reading time">
                  15分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>简介： Tiny Web 项目 </p>
<a id="more"></a>


<h1 id="客户端-服务器编程模型"><a href="#客户端-服务器编程模型" class="headerlink" title="客户端-服务器编程模型"></a>客户端-服务器编程模型</h1><p>&emsp;&emsp;客户端-服务器编程模型是一个典型的进程间通信模型。客户端进程和服务器进程通常分处两个不同的主机，如下图所示，客户端发送请求给服务器，服务器从本地资源库中查找需要的资源，然后发送响应给客户端，最后客户端（通常是浏览器）处理这个响应，把结果显示在浏览器上。<br><img src="https://cy-pic.kuaizhan.com/g3/16/84/727b-027a-4fe5-885c-5e3c480ca81200?sign=3d85ce18f45e8dd3544935e1884fddaa&t=1572860741" alt=""></p>
<p>&emsp;&emsp;这个过程看起来很简单，但是我们需要深入具体的实现细节。我们知道，TCP是基于连接的，需要先建立连接才能互相通信。在Linux中，socket为我们提供了方便的解决方案。每一对网络连接称为一个socket对，包括两个端点的socket地址，表示如下：<strong>(cliaddr : cliport, servaddr : servport)</strong></p>
<h1 id="C-S流程图"><a href="#C-S流程图" class="headerlink" title="C/S流程图"></a>C/S流程图</h1><p><img src="https://cy-pic.kuaizhan.com/g3/f0/06/7e7f-cec2-42d4-bf82-0b6eb453137992?sign=5af41daccf2b93eeda432cd7ede0a2b4&t=1572860706" alt=""><br>&emsp;&emsp;服务器调用socket函数获取一个socket，然后调用bind函数绑定本机的IP地址和端口，再调用listen函数开启监听，最后调用accept函数等待直到有客户端发起连接。</p>
<p>&emsp;&emsp;另一方面，客户端调用socket函数获取一个socket，然后调用connect函数向指定服务器发起连接请求，当连接成功或出现错误后返回。若连接成功，服务器端的accept函数也会成功返回，返回另一个已连接的socket（不是最初调用socket函数得到的socket），该socket可以直接用于与客户端通信。而服务器最初的那个socket可以继续循环调用accept函数，等待下一次连接的到来。</p>
<p>&emsp;&emsp;连接成功后，无论是客户端还是服务器，只要向socket读写数据就可以实现与对方socket的通信。图中rio_readlineb和rio_written是作者封装的I/O读写函数，与Linux系统提供的read和write作用基本相同。</p>
<p>&emsp;&emsp;客户端关闭连接时会发送一个EOF到服务器，服务器读取后关闭连接，进入下一个循环。这里面用到的所有Linux网络编程接口都定义在&lt;sys/socket.h&gt;头文件中。</p>
<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><h2 id="HTTP-请求"><a href="#HTTP-请求" class="headerlink" title="HTTP 请求"></a>HTTP 请求</h2><p>&emsp;&emsp;一个HTTP请求：一个请求行(request line) 后面跟随0个或多个请求报头(request header), 再跟随一个空的文本行来终止报头。</p>
<p>&emsp;&emsp;请求行： <code>&lt;method&gt; &lt;uri&gt; &lt;version&gt;</code></p>
<p>&emsp;&emsp;请求报头：<code>&lt;header name&gt; : &lt;header data&gt;</code> 为服务器提供了额外的信息，例如浏览器的版本类型</p>
<h2 id="HTTP响应"><a href="#HTTP响应" class="headerlink" title="HTTP响应"></a>HTTP响应</h2><p>&emsp;&emsp;一个HTTP响应：一个响应行(response line) 后面跟随0个或多个响应报头(response header)，再跟随一个空的文本行来终止报头，最后跟随一个响应主体(response body)。</p>
<h1 id="服务动态内容"><a href="#服务动态内容" class="headerlink" title="服务动态内容"></a>服务动态内容</h1><h2 id="客户端如何将程序参数传递给服务器"><a href="#客户端如何将程序参数传递给服务器" class="headerlink" title="客户端如何将程序参数传递给服务器"></a>客户端如何将程序参数传递给服务器</h2><p>&emsp;&emsp;GET请求的参数在URI中传递，“?”字符分隔了文件名和参数，每个参数都用一个”&amp;”分隔开，参数中不允许有空格，必须用字符串“%20”来表示。</p>
<h2 id="服务器如何将参数传递给子进程"><a href="#服务器如何将参数传递给子进程" class="headerlink" title="服务器如何将参数传递给子进程"></a>服务器如何将参数传递给子进程</h2><pre><code>GET /cgi-bin/adder?123&amp;456 HTTP/1.1</code></pre><p>&emsp;&emsp;它调用 fork 来创建一个子进程，并调用 execve 在子进程的上下文中执行 /cgi-bin/adder 程序。</p>
<p>&emsp;&emsp;在调用 execve 之前，子进程将CGI环境变量 QUERY_STRING 设置为”123&amp;456”， adder 程序在运行时可以用unix getenv 函数来引用它。</p>
<h2 id="服务器如何将其他信息传递给子进程"><a href="#服务器如何将其他信息传递给子进程" class="headerlink" title="服务器如何将其他信息传递给子进程"></a>服务器如何将其他信息传递给子进程</h2><p><img src="https://cy-pic.kuaizhan.com/g3/78/d7/0e85-0be1-4da3-92d9-3a12a4f9e57d06?sign=f02b8de39d7be9b21cb411eb7c2e9667&t=1572863982" alt=""></p>
<h2 id="子进程将它的输出发送到哪里"><a href="#子进程将它的输出发送到哪里" class="headerlink" title="子进程将它的输出发送到哪里"></a>子进程将它的输出发送到哪里</h2><p>&emsp;&emsp;一个CGI程序将它的动态内容发送到标准输出，在子进程加载并运行CGI程序之前，它使用UNIX dup2 函数将它标准输出重定向到和客户端相关连的已连接描述符。因此，任何CGI程序写到标准输出的东西都会直接到达客户端。</p>
<h1 id="Tiny-Web服务器代码分析"><a href="#Tiny-Web服务器代码分析" class="headerlink" title="Tiny Web服务器代码分析"></a>Tiny Web服务器代码分析</h1><h2 id="main函数-amp-open-listenfd函数"><a href="#main函数-amp-open-listenfd函数" class="headerlink" title="main函数 &amp; open_listenfd函数"></a>main函数 &amp; open_listenfd函数</h2><p>&emsp;&emsp;Tiny是一个迭代服务器，监听在命令行中传递来的端口上的连接请求，在通过调用 open_listenfd 函数打开一个监听套接字以后，执行无限服务器循环，不断接受连接请求，执行事务，并关闭连接它的那一端。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> open_listenfd(char *port)</span><br><span class="line">&#123;</span><br><span class="line">    struct addrinfo hints,*p,*listp;</span><br><span class="line">    <span class="keyword">int</span> listenfd, optval=<span class="number">1</span>,rc;</span><br><span class="line">    memset(&amp;hints, <span class="number">0</span>, sizeof(struct addrinfo));</span><br><span class="line">    hints.ai_socktype=SOCK_STREAM;</span><br><span class="line">    hints.ai_flags = AI_PASSIVE | AI_ADDRCONFIG;</span><br><span class="line">    hints.ai_flags |= AI_NUMERICSERV;</span><br><span class="line">    //<span class="keyword">socket</span>----&gt;<span class="keyword">bind</span>----&gt;<span class="keyword">listen</span></span><br><span class="line">    getaddrinfo(NULL, port, &amp;hints, &amp;listp);</span><br><span class="line">   // <span class="keyword">if</span>(listp == NULL) </span><br><span class="line">    <span class="keyword">for</span>(p=listp; p; p=p-&gt;ai_next)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((listenfd=<span class="keyword">socket</span>(p-&gt;ai_family, p-&gt;ai_socktype, p-&gt;ai_protocol)) &lt; <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">       <span class="keyword">if</span>((rc= <span class="keyword">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp; optval, sizeof(<span class="keyword">int</span>))) &lt; <span class="number">0</span>) <span class="keyword">printf</span>(<span class="string">"%s\n"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">bind</span>(listenfd, p-&gt;ai_addr, p-&gt;ai_addrlen) == <span class="number">0</span>)     //<span class="keyword">printf</span>(<span class="string">"%s\n"</span>, strerror(errno)); <span class="regexp">//break</span>;</span><br><span class="line">        		<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">close</span>(listenfd);</span><br><span class="line">    &#125;</span><br><span class="line">    freeaddrinfo(listp);</span><br><span class="line">    <span class="keyword">if</span>(!p)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">listen</span>(listenfd, LISTENQ) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> listenfd;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> listenfd,connfd;</span><br><span class="line">    socklen_t clientlen;</span><br><span class="line">    char hostname[MAXNLINE], port[MAXNLINE];</span><br><span class="line">    struct sockaddr_storage clientaddr;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">"usage: %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listenfd=open_listenfd(argv[<span class="number">1</span>]);</span><br><span class="line">    //<span class="keyword">printf</span>(<span class="string">"%d"</span>, listenfd);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        clientlen = sizeof(clientaddr); </span><br><span class="line">        connfd = <span class="keyword">accept</span>(listenfd, (struct sockaddr *)&amp;clientaddr, &amp;clientlen);    <span class="regexp">//</span>等待客户端连接请求 </span><br><span class="line">        getnameinfo((struct sockaddr*)&amp; clientaddr, clientlen, hostname, MAXNLINE, port, MAXNLINE, <span class="number">0</span>);</span><br><span class="line">       // <span class="keyword">printf</span>(<span class="string">"\n%d\n"</span>, connfd);</span><br><span class="line">        <span class="keyword">printf</span>(<span class="string">"Accept connection from (%s %s)\n"</span>, hostname, port);</span><br><span class="line">      //  <span class="keyword">if</span>(connfd==<span class="number">152</span> || connfd ==<span class="number">153</span> || connfd==<span class="number">151</span> || connfd==<span class="number">154</span> || connfd==<span class="number">147</span>)<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        doit(connfd);</span><br><span class="line">        <span class="keyword">close</span>(connfd);</span><br><span class="line">        //<span class="keyword">if</span>( <span class="keyword">close</span>(connfd) &lt; <span class="number">0</span>) <span class="keyword">printf</span>(<span class="string">"%s"</span>, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="doit函数"><a href="#doit函数" class="headerlink" title="doit函数"></a>doit函数</h2><p>&emsp;&emsp;doit函数处理一个HTTP事务，首先读和解析请求行(request line)，注意，我们使用rio_readlineb函数读取请求行。<br>Tiny只支持GET方法，如果客户端请求其他方法，发送一个错误信息。<br>然后将URI解析为一个文件名和一个可能为空的CGI参数字符串，并且设置一个标志表明请求的是静态内容还是动态内容,如果请求的是静态内容，就验证是否为普通文件，有读权限如果请求的是动态内容，就验证是否为可执行文件，如果是，就提供动态内容。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">void doit(<span class="built_in">int</span> fd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> is_static;</span><br><span class="line">    <span class="keyword">struct</span> stat sbuf;</span><br><span class="line">    <span class="built_in">char</span> buf<span class="literal">[MAXNLINE]</span>, filename<span class="literal">[MAXNLINE]</span>, uri<span class="literal">[MAXNLINE]</span>, verson<span class="literal">[MAXNLINE]</span>;</span><br><span class="line">    <span class="built_in">char</span> <span class="keyword">method</span><span class="literal">[MAXNLINE]</span>, cgiargs<span class="literal">[MAXNLINE]</span>;   </span><br><span class="line">    rio_t rio;</span><br><span class="line"></span><br><span class="line">    rio<span class="constructor">_readinitb(&amp;<span class="params">rio</span>, <span class="params">fd</span>)</span>;        <span class="comment">//fd是与服务器通信的套接字 </span></span><br><span class="line">    rio<span class="constructor">_readlineb(&amp;<span class="params">rio</span>, <span class="params">buf</span>, MAXNLINE)</span>;</span><br><span class="line">    printf(<span class="string">"Request headers:\n"</span>);</span><br><span class="line">    printf(<span class="string">"%s"</span>, buf);</span><br><span class="line">    sscanf(buf, <span class="string">"%s %s %s"</span>, <span class="keyword">method</span>, uri, verson);</span><br><span class="line">    <span class="keyword">if</span>(strcasecmp(<span class="keyword">method</span>, <span class="string">"GET"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        clienterror(fd, <span class="keyword">method</span>, <span class="string">"501"</span>, <span class="string">"Not implemented"</span>, <span class="string">"Tiny does not implement this method"</span>);</span><br><span class="line">        return ;</span><br><span class="line">    &#125;</span><br><span class="line">    read<span class="constructor">_requesthds(&amp;<span class="params">rio</span>)</span>;       <span class="comment">//读请求头 </span></span><br><span class="line">    is_static = prase<span class="constructor">_uri(<span class="params">uri</span>, <span class="params">filename</span>, <span class="params">cgiargs</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span>(stat(filename, &amp;sbuf) &lt; <span class="number">0</span>)   <span class="comment">//通过文件名获取文件信息 </span></span><br><span class="line">    &#123;</span><br><span class="line">       clienterror(fd, filename, <span class="string">"404"</span>, <span class="string">"Not Found"</span>, <span class="string">"Tiny couldn't find this file"</span>);  <span class="comment">//返回错误信息 </span></span><br><span class="line">        return ; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(is_static==<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="constructor">S_ISREG(<span class="params">sbuf</span>.<span class="params">st_mode</span>)</span>) <span class="pattern-match"><span class="operator">||</span>!(sbuf.st<span class="constructor">_mode</span> &amp; <span class="constructor">S_IRUSR</span>))</span></span><br><span class="line"><span class="pattern-match">        &#123;</span></span><br><span class="line"><span class="pattern-match">            clienterror(fd, filename, "403", "<span class="constructor">Not</span> <span class="constructor">Found</span>", "<span class="constructor">Tiny</span> couldn't read this file");  </span></span><br><span class="line"><span class="pattern-match">            return ;    </span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">        serve<span class="constructor">_static(<span class="params">fd</span>, <span class="params">filename</span>, <span class="params">sbuf</span>.<span class="params">st_size</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">else</span></span></span><br><span class="line"><span class="pattern-match">    &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="keyword">if</span>(!<span class="constructor">S_ISREG(<span class="params">sbuf</span>.<span class="params">st_mode</span>)</span> <span class="operator">||</span> !(<span class="constructor">S_IRUSR</span> &amp; sbuf.st<span class="constructor">_mode</span>))</span></span><br><span class="line"><span class="pattern-match">        &#123;</span></span><br><span class="line"><span class="pattern-match">            clienterror(fd, filename, "403", "<span class="constructor">Forbidden</span>", "<span class="constructor">Tiny</span> couldn't run the <span class="constructor">CGI</span> program");  </span></span><br><span class="line"><span class="pattern-match">            return ;</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">        serve<span class="constructor">_dynamic(<span class="params">fd</span>, <span class="params">filename</span>, <span class="params">cgiargs</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">     &#125; </span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="clienterror函数"><a href="#clienterror函数" class="headerlink" title="clienterror函数"></a>clienterror函数</h2><p>&emsp;&emsp;clienterror函数检查一些明显的错误，并把它报告给客户端。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void clienterror(<span class="built_in">int</span> fd, <span class="built_in">char</span> *cause, <span class="built_in">char</span> *errnum, <span class="built_in">char</span> *shortmsg, <span class="built_in">char</span> *longmsg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">char</span> buf<span class="literal">[MAXNLINE]</span>,body<span class="literal">[MAXNLINE]</span>;</span><br><span class="line">    <span class="comment">//build http response body</span></span><br><span class="line">    sprintf(body, <span class="string">"&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;"</span>);</span><br><span class="line">    sprintf(body, <span class="string">"%s&lt;body bgcolor="</span><span class="string">"ffffff"</span><span class="string">"&gt;\r\n"</span>, body);</span><br><span class="line">    sprintf(body, <span class="string">"%s%s: %s\r\n"</span>, body, errnum, shortmsg);</span><br><span class="line">    sprintf(body, <span class="string">"%s&lt;p&gt;%s: %s\r\n"</span>, body, longmsg, cause);</span><br><span class="line">    sprintf(body, <span class="string">"%s&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n"</span>, body);</span><br><span class="line">    <span class="comment">//打印信息 </span></span><br><span class="line">    sprintf(buf, <span class="string">"HTTP/1.0 %s %s\r\n"</span>, errnum, shortmsg);</span><br><span class="line">    rio<span class="constructor">_writen(<span class="params">fd</span>, <span class="params">buf</span>, <span class="params">strlen</span>(<span class="params">buf</span>)</span>);</span><br><span class="line">    sprintf(buf, <span class="string">"Content-type: text/html\r\n"</span>);</span><br><span class="line">    rio<span class="constructor">_writen(<span class="params">fd</span>, <span class="params">buf</span>, <span class="params">strlen</span>(<span class="params">buf</span>)</span>);</span><br><span class="line">    sprintf(buf, <span class="string">"Content-length: %d\r\n\r\n"</span>, (<span class="built_in">int</span>)strlen(body));</span><br><span class="line">    rio<span class="constructor">_writen(<span class="params">fd</span>, <span class="params">buf</span>, <span class="params">strlen</span>(<span class="params">buf</span>)</span>);</span><br><span class="line">    rio<span class="constructor">_writen(<span class="params">fd</span>, <span class="params">body</span>, <span class="params">strlen</span>(<span class="params">body</span>)</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="read-requesthdrs函数"><a href="#read-requesthdrs函数" class="headerlink" title="read_requesthdrs函数"></a>read_requesthdrs函数</h2><p>&emsp;&emsp;Tiny不使用请求报头中的任何信息，仅仅调用 read_requesthdrs函数来读取并忽略这些报头。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void read<span class="constructor">_requesthds(<span class="params">rio_t</span> <span class="operator">*</span><span class="params">rp</span>)</span>       <span class="comment">//鎶把请求头读出来 </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">char</span> buf<span class="literal">[MAXNLINE]</span>;</span><br><span class="line">    rio<span class="constructor">_readlineb(<span class="params">rp</span>, <span class="params">buf</span>, MAXNLINE)</span>;</span><br><span class="line">    printf(<span class="string">"%s"</span>, buf);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(strcmp(buf, <span class="string">"\r\n"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        rio<span class="constructor">_readlineb(<span class="params">rp</span> , <span class="params">buf</span>, MAXNLINE)</span>;</span><br><span class="line">        printf(<span class="string">"%s"</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    return ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parse-uri函数"><a href="#parse-uri函数" class="headerlink" title="parse_uri函数"></a>parse_uri函数</h2><p>&emsp;&emsp;Tiny假设静态内容的主目录就是当前目录，可执行文件的主目录是 ./cgi-bin/ 任何包含字符串 cgi-bin 的URI都认为是对动态内容的请求。</p>
<p>&emsp;&emsp;首先将URI解析为一个文件名和一个可选的CGI参数字符串，如果请求的是静态内容，就清除CGI参数串(第6行)，然后将URI转换为一个相对的unix 路径名，例如 ./index.html。</p>
<p>&emsp;&emsp;如果URI是用’/‘ 结尾的,我们就把默认的文件名加在后面。如果请求的是动态内容，就会抽取所有的CGI参数，并将URI剩下的部分转换为一个相应的unix文件名</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">prase_uri</span><span class="params">(<span class="keyword">char</span> *uri, <span class="keyword">char</span> *filename, <span class="keyword">char</span> *cgiargs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ptr;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strstr</span>(uri, <span class="string">"cgi-bin"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(cgiargs, <span class="string">""</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(filename, <span class="string">"."</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(filename, uri);</span><br><span class="line">        <span class="keyword">if</span>(uri[<span class="built_in">strlen</span>(uri)<span class="number">-1</span>]==<span class="string">'/'</span>) <span class="built_in">strcat</span>(filename, <span class="string">"home.html"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ptr = index(uri, <span class="string">'?'</span>);</span><br><span class="line">        <span class="keyword">if</span>(ptr)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(cgiargs, ptr+<span class="number">1</span>);</span><br><span class="line">            *ptr=<span class="string">'\0'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">strcpy</span>(cgiargs, <span class="string">""</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(filename, <span class="string">"."</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(filename, uri);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="serve-static函数"><a href="#serve-static函数" class="headerlink" title="serve_static函数"></a>serve_static函数</h2><p>&emsp;&emsp;Tiny提供四种不同的静态内容：HTML文件、无格式的文本文件、GIF编码格式图片、JPEG编码格式图片。serve_static 函数发送一个HTTP响应，其主体包含一个本地文件的内容。</p>
<p>&emsp;&emsp;首先我们通过检查文件名的后缀来判断文件类型，并且发送响应行和响应报头给客户端。注意用一个空行终止报头，我们使用 unix mmap函数将被请求文件映射到一个虚拟存储器空间，调用mmap将文件srcfd的前filesize个字节映射到一个从地址srcp开始的私有只读虚拟存储器区域。</p>
<p>&emsp;&emsp;一旦文件映射到存储器，就不再需要它的描述符了，关闭这个文件。rio_writen 函数拷贝从srcp位置开始的filesize个字节(已经被映射到了所请求的文件) 到客户端的已连接描述符。最后释放了映射的虚拟存储器区域，避免潜在的内存泄露。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getfiletype</span><span class="params">(<span class="keyword">char</span> *filename, <span class="keyword">char</span> *filetype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strstr</span>(filename, <span class="string">".html"</span>))   <span class="built_in">strcpy</span>(filetype, <span class="string">"text/html"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>(filename, <span class="string">".gif"</span>))   <span class="built_in">strcpy</span>(filetype, <span class="string">"image/gif"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>(filename, <span class="string">".png"</span>))   <span class="built_in">strcpy</span>(filetype, <span class="string">"image/png"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>(filename, <span class="string">".jpg"</span>))   <span class="built_in">strcpy</span>(filetype, <span class="string">"image/jpeg"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">strcpy</span>(filetype, <span class="string">"text/plain"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serve_static</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *filename, <span class="keyword">int</span> filesize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> srcfd;</span><br><span class="line">    <span class="keyword">char</span> *srcp, filetype[MAXNLINE], buf[MAXNLINE];</span><br><span class="line">    <span class="comment">//  发送响应报头给客户端 </span></span><br><span class="line">    getfiletype(filename, filetype);      <span class="comment">//返回静态内容类型 </span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"%sServer: Tiny Web Server\r\n"</span>, buf);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"%sConnection: close\r\n"</span>, buf);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"%sContent-length %d\r\n"</span>, buf, filesize);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"%sContent-type: %s\r\n\r\n"</span>, buf, filetype);</span><br><span class="line">    rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Response headers:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  发送响应体给客户端 </span></span><br><span class="line">    srcfd = open(filename, O_RDONLY, <span class="number">0</span>); </span><br><span class="line">    srcp = mmap(<span class="number">0</span>, filesize, PROT_READ, MAP_PRIVATE, srcfd, <span class="number">0</span>);</span><br><span class="line">    close(srcfd);</span><br><span class="line">    rio_writen(fd, srcp, filesize);</span><br><span class="line">    munmap(srcp, filesize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="serve-dynamic-函数"><a href="#serve-dynamic-函数" class="headerlink" title="serve_dynamic 函数"></a>serve_dynamic 函数</h2><p>&emsp;&emsp;Tiny通过派生一个子进程并在子进程的上下文中运行一个CGI程序，来提供各种类型的动态内容。</p>
<p>&emsp;&emsp;serve_dynamic函数一开始就向客户端发送一个表明成功的响应行，同时还包括带有信息的server报头。</p>
<p>&emsp;&emsp;子进程用来自请求URI的CGI参数初始化QUERY_STRING环境变量</p>
<p>&emsp;&emsp;子进程重定向它的标准输出到已连接文件描述符</p>
<p>&emsp;&emsp;加载并运行CGI程序，因为CGI程序运行在子进程的上下文中，它能够访问所有在调用execve函数之前就存在的打开文件和环境变量</p>
<p>&emsp;&emsp;父进程阻塞在对wait的调用中，等待子进程终止的时候，回收操作系统那个分配给子进程的资源</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void serve<span class="constructor">_dynamic(<span class="params">int</span> <span class="params">fd</span>, <span class="params">char</span> <span class="operator">*</span><span class="params">filename</span>, <span class="params">char</span> <span class="operator">*</span><span class="params">cgiargs</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">char</span> buf<span class="literal">[MAXNLINE]</span>, *emptylist<span class="literal">[]</span>=&#123;NULL&#125;;</span><br><span class="line">    pid_t pid;</span><br><span class="line">    printf(<span class="string">"-----------%s-------------"</span>, cgiargs);</span><br><span class="line">    sprintf(buf, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    rio<span class="constructor">_writen(<span class="params">fd</span>, <span class="params">buf</span>, <span class="params">strlen</span>(<span class="params">buf</span>)</span>);</span><br><span class="line">    sprintf(buf, <span class="string">"Server: Tiny Web Server\r\n"</span>);</span><br><span class="line">    rio<span class="constructor">_writen(<span class="params">fd</span>, <span class="params">buf</span>, <span class="params">strlen</span>(<span class="params">buf</span>)</span>);</span><br><span class="line">    pid=fork<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        setenv(<span class="string">"QUERY_STRING"</span>, cgiargs, <span class="number">1</span>);   <span class="comment">//改变或者增加环境变量内容，为1则改 </span></span><br><span class="line">        dup2(fd, STDOUT_FILENO);</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        *         来执行参数filename字符串所代表的文件路径，第二个参数是利</span></span><br><span class="line"><span class="comment">		    用数组指针来传递给执行文件，并且需要以空指针(NULL)结束，最后一个参数则为传递给执行文件</span></span><br><span class="line"><span class="comment">			    的新环境变量数组。execve()用来执行参数filename字符串所代表的文件路径，第二个参数是利用数组指针来传递给执</span></span><br><span class="line"><span class="comment">			  行文件，并且需要以空指针(NULL)结束，最后一个参数则为传递给执行文件的新环境变量数组</span></span><br><span class="line"><span class="comment">			  */</span> </span><br><span class="line">        execve(filename, emptylist, environ);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">else</span>  wait(NULL);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="rio函数"><a href="#rio函数" class="headerlink" title="rio函数"></a>rio函数</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXNLINE 1024*8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LISTENQ 1024</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> **environ;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> rio_fd,rio_cnt;</span><br><span class="line">    <span class="keyword">char</span> rio_buf[MAXNLINE],*rio_bufptr;</span><br><span class="line">&#125; <span class="keyword">rio_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> rio_writen(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> nleft=n;</span><br><span class="line">    <span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">    <span class="keyword">char</span> *bufp=usrbuf;</span><br><span class="line">    <span class="keyword">while</span>(nleft&gt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((nwritten = write(fd, bufp, nleft)) &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(errno == EINTR)</span><br><span class="line">            &#123;</span><br><span class="line">                nwritten=<span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nleft-=nwritten;</span><br><span class="line">        bufp+=nwritten;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rio_readinitb</span><span class="params">(<span class="keyword">rio_t</span> *rio, <span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rio-&gt;rio_fd=fd;</span><br><span class="line">    rio-&gt;rio_cnt=<span class="number">0</span>;</span><br><span class="line">    rio-&gt;rio_bufptr=rio-&gt;rio_buf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">rio_read</span><span class="params">(<span class="keyword">rio_t</span> *rp, <span class="keyword">char</span> *rc, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt;</span><br><span class="line">    <span class="keyword">while</span>(rp-&gt;rio_cnt&lt;=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        rp-&gt;rio_cnt=read(rp-&gt;rio_fd, rp-&gt;rio_buf, <span class="keyword">sizeof</span>(rp-&gt;rio_buf));</span><br><span class="line">        <span class="keyword">if</span>(rp-&gt;rio_cnt&lt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(errno != EINTR)  <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">//此时为不中断 </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(rp-&gt;rio_cnt==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> rp-&gt;rio_bufptr=rp-&gt;rio_buf;</span><br><span class="line">    &#125;</span><br><span class="line">    cnt=n;</span><br><span class="line">    <span class="keyword">if</span>(rp-&gt;rio_cnt &lt; n) cnt=rp-&gt;rio_cnt;</span><br><span class="line">    <span class="built_in">memcpy</span>(rc, rp-&gt;rio_bufptr, cnt);</span><br><span class="line">    rp-&gt;rio_bufptr+=cnt;</span><br><span class="line">    rp-&gt;rio_cnt-=cnt;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> rio_readlineb(<span class="keyword">rio_t</span> *rp, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> maxnlen)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> *buf=usrbuf,c;</span><br><span class="line">    <span class="keyword">int</span> n,rc;</span><br><span class="line">    <span class="keyword">for</span>(n=<span class="number">1</span>; n&lt;maxnlen; ++n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((rc=rio_read(rp, &amp;c, <span class="number">1</span>))==<span class="number">1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            *buf++ = c;</span><br><span class="line">            <span class="keyword">if</span>(c == <span class="string">'\n'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                n++;</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(rc == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(n==<span class="number">1</span>)    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">    *buf=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> n<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux-C-C/"<i class="fa fa-tag"></i> Linux C/C++</a>
          
            <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"<i class="fa fa-tag"></i> 网络编程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/04/echo%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="prev" title="echo服务器">
                echo服务器 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://p2.so.qhmsg.com/t010d44e4aa0fd98f91.jpg"
                alt="Tudou" />
            
              <p class="site-author-name" itemprop="name">Tudou</p>
              <p class="site-description motion-element" itemprop="description">study & life</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/hnutudou" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#客户端-服务器编程模型"><span class="nav-number">1.</span> <span class="nav-text">客户端-服务器编程模型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#C-S流程图"><span class="nav-number">2.</span> <span class="nav-text">C/S流程图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP"><span class="nav-number">3.</span> <span class="nav-text">HTTP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-请求"><span class="nav-number">3.1.</span> <span class="nav-text">HTTP 请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP响应"><span class="nav-number">3.2.</span> <span class="nav-text">HTTP响应</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#服务动态内容"><span class="nav-number">4.</span> <span class="nav-text">服务动态内容</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#客户端如何将程序参数传递给服务器"><span class="nav-number">4.1.</span> <span class="nav-text">客户端如何将程序参数传递给服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器如何将参数传递给子进程"><span class="nav-number">4.2.</span> <span class="nav-text">服务器如何将参数传递给子进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器如何将其他信息传递给子进程"><span class="nav-number">4.3.</span> <span class="nav-text">服务器如何将其他信息传递给子进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#子进程将它的输出发送到哪里"><span class="nav-number">4.4.</span> <span class="nav-text">子进程将它的输出发送到哪里</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tiny-Web服务器代码分析"><span class="nav-number">5.</span> <span class="nav-text">Tiny Web服务器代码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#main函数-amp-open-listenfd函数"><span class="nav-number">5.1.</span> <span class="nav-text">main函数 &amp; open_listenfd函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#doit函数"><span class="nav-number">5.2.</span> <span class="nav-text">doit函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#clienterror函数"><span class="nav-number">5.3.</span> <span class="nav-text">clienterror函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#read-requesthdrs函数"><span class="nav-number">5.4.</span> <span class="nav-text">read_requesthdrs函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parse-uri函数"><span class="nav-number">5.5.</span> <span class="nav-text">parse_uri函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serve-static函数"><span class="nav-number">5.6.</span> <span class="nav-text">serve_static函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serve-dynamic-函数"><span class="nav-number">5.7.</span> <span class="nav-text">serve_dynamic 函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rio函数"><span class="nav-number">5.8.</span> <span class="nav-text">rio函数</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tudou</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>